<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>OneDay Research</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.1.3/css/bootstrap.min.css">
</head>
<body>

<div th:insert="~{fragments/navbar :: nav_bar('Create')}"></div>
<div class="container">

    <h3 class="my-4">Create Research</h3>

    <div id="create-form">
        <div class="mb-3">
            <label for="research-title-input" class="form-label">Title</label>
            <input type="text" class="form-control" id="research-title-input" name="title"
                   th:value="${rsDTO.sur_title}"
                   onkeyup="validateTitle(this)">
            <small id="title-help" class="form-text text-muted">0 / 100 characters</small>
        </div>
        <div class="mb-3">
            <label for="research-writer-input" class="form-label">Writer</label>
            <input type="text" class="form-control" id="research-writer-input" name="writer"
                   th:value="${rsDTO.reg_name}" disabled>
        </div>
        <!--        기간 (달력 팝업)-->

        <div class="mb-3 row">
            <label for="research-startdate-input" class="col-2 col-form-label">Start Date</label>
            <div class="col-4">
                <input type="datetime-local" class="form-control" id="research-startdate-input" name="startdate"
                       th:value="${rsDTO.sur_sat_date}"
                       th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd''T''HH:mm')}"
                       oninput="document.querySelector('#research-enddate-input').min = this.value;">
            </div>

            <label for="research-enddate-input" class="col-2 col-form-label">End Date</label>
            <div class="col-4">
                <input type="datetime-local" class="form-control" id="research-enddate-input" name="enddate"
                       th:value="${rsDTO.sur_end_date}"
                       th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd''T''HH:mm')}">
            </div>
        </div>

        <div class="mb-3">
            <label for="research-content-input" class="form-label">Content</label>
            <textarea class="form-control" id="research-content-input" name="content" rows="6"
                      onkeyup="validateContent(this)">
                [[${rsDTO.sur_desc}]]
            </textarea>
            <small id="content-help" class="form-text text-muted">0 / 1000 characters</small>
        </div>

        <!--        <div class="mb-3">-->
        <!--            <label for="num-of-questions-input" class="form-label">Number of Questions</label>-->
        <!--            <input type="number" class="form-control" id="num-of-questions-input" name="num_of_questions" min="1"-->
        <!--                   value="1">-->
        <!--        </div>-->
        <div class="mb-3">
            <button type="button" class="btn btn-primary" id="add-question-button" onclick="addSuriForm(document.querySelector('#research-query-container').childElementCount + 1)">Plus Query</button>
            <button type="button" class="btn btn-primary" id="remove-question-button" onclick="deleteSuriForm()">Minus Query</button>
            <button type="button" class="btn btn-primary" id="save-button" onclick="updateResearchDTO()">Save</button>
        </div>
        <div id="research-query-container"></div>


    </div>
</div>
<script>

    // let rs = {
    //     sur_seq: 1,
    //     sur_title: "test",
    //     sur_desc: "test",
    //     que_cnt: '5',
    //     hits: '0',
    //     sur_sat_date: "2023-10-01",
    //     sur_end_date: "2023-10-31",
    //     reg_name: "test",
    //     reg_date: "2023-10-01",
    //     use_yn: "n",
    //     suri:[
    //         {
    //             sur_seq: '1',
    //             suri_seq: '1',
    //             suri_no: '1',
    //             suri_title: "설문 테스트1",
    //             suri_que1: "질문사항1",
    //             suri_que2: "질문사항2",
    //             suri_que3: "질문사항3",
    //             suri_que4: "질문사항4",
    //             suri_que5: "질문사항5",
    //             suri_type: "1",
    //             suri_multi: "1",
    //             suri_etc: "n",
    //             reg_name: "zombil8731",
    //             reg_date: "2023-10-01",
    //         },
    //         {
    //             sur_seq: '1',
    //             suri_seq: '10',
    //             suri_no: '2',
    //             suri_title: "설문 테스트2",
    //             suri_que1: "질문사항1",
    //             suri_que2: "질문사항2",
    //             suri_que3: "질문사항3",
    //             suri_que4: "질문사항4",
    //             suri_que5: "질문사항5",
    //             suri_type: "1",
    //             suri_multi: "1",
    //             suri_etc: "n",
    //             reg_name: "zombil8731",
    //             reg_date: "2023-10-01",
    //         },
    //         {
    //             sur_seq: '1',
    //             suri_seq: '11',
    //             suri_no: '3',
    //             suri_title: "설문 테스트3",
    //             suri_que1: "질문사항1",
    //             suri_que2: "질문사항2",
    //             suri_que3: "질문사항3",
    //             suri_que4: "질문사항4",
    //             suri_que5: "질문사항5",
    //             suri_type: "1",
    //             suri_multi: "1",
    //             suri_etc: "n",
    //             reg_name: "zombil8731",
    //             reg_date: "2023-10-01",
    //         },
    //         {
    //             sur_seq: '1',
    //             suri_seq: '21',
    //             suri_no: '4',
    //             suri_title: "설문 테스트4",
    //             suri_que1: "질문사항1",
    //             suri_que2: "질문사항2",
    //             suri_que3: "질문사항3",
    //             suri_que4: "질문사항4",
    //             suri_que5: "질문사항5",
    //             suri_type: "1",
    //             suri_multi: "1",
    //             suri_etc: "n",
    //             reg_name: "zombil8731",
    //             reg_date: "2023-10-01",
    //         },
    //         {
    //             sur_seq: '1',
    //             suri_seq: '3',
    //             suri_no: '5',
    //             suri_title: "설문 테스트5",
    //             suri_que1: "질문사항1",
    //             suri_que2: "질문사항2",
    //             suri_que3: "질문사항3",
    //             suri_que4: "질문사항4",
    //             suri_que5: "질문사항5",
    //             suri_type: "1",
    //             suri_multi: "1",
    //             suri_etc: "n",
    //             reg_name: "zombil8731",
    //             reg_date: "2023-10-01",
    //         }
    //     ]
    // };
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let rs = [[${rs}]];
    let deletedQueryId=[];
    /*]]>*/
    console.log(rs)
    console.log(111)
</script>
<script>
    // 페이지 로드 시 초기 데이터를 rsDTO에서 가져와서 suri 폼을 생성합니다.

    window.addEventListener('load', function () {
        loadRS();
    });

    // rsDTO를 이용하여 초기 suri 폼을 생성하는 함수
    function loadRS() {
        let suriList = rs.suri;
        suriList.sort((a, b) => {
            return a.suri_no - b.suri_no;
        })
        let lastSuriNo = suriList[suriList.length - 1]
        if (lastSuriNo) {
            lastSuriNo = lastSuriNo.suri_no
            for (let i = 1; i <= lastSuriNo; i++) {
                addSuriForm(i);
            }
        }
        // let lastSuriNo = suriList[suriList.length - 1].suri_no;
    }

    function updateResearchDTO() {
        const suriForms = document.querySelectorAll('.suri-form');
        const updatedSuriData = [];
        suriForms.forEach((form, index) => {
            const questionNumber = index + 1;
            const suriData = {
                sur_seq: rs.sur_seq,
                suri_seq: form.querySelector(`input[name^="suri_seq_"]`).value,
                suri_no: form.querySelector(`input[name^="suri_no_"]`).value,
                suri_title: form.querySelector(`input[name^="suri_title_"]`).value,
                suri_que1: form.querySelector(`input[name^="suri_que1_"]`).value,
                suri_que2: form.querySelector(`input[name^="suri_que2_"]`).value,
                suri_que3: form.querySelector(`input[name^="suri_que3_"]`).value,
                suri_que4: form.querySelector(`input[name^="suri_que4_"]`).value,
                suri_que5: form.querySelector(`input[name^="suri_que5_"]`).value,
                suri_type: form.querySelector(`input[name^="suri_type_"]:checked`) ? '3' : '1',
                suri_reason: form.querySelector(`input[name^="suri_reason_"]`).value,
            };

            updatedSuriData.push(suriData);
        });

        // rs 업데이트
        rs.suri = updatedSuriData;

        // research-title-input
        rs.sur_title = document.getElementById('research-title-input').value;
        // research-content-input
        rs.sur_desc = document.getElementById('research-content-input').value;
        // research-startdate-input
        rs.sur_sat_date = document.getElementById('research-startdate-input').value;
        // research-enddate-input
        rs.sur_end_date = document.getElementById('research-enddate-input').value;
        // num-of-questions-input
        // rs.que_cnt = document.getElementById('num-of-questions-input').value;
        // deletedQueryId
        // rs.deletedQueryId=deletedQueryId

        // TODO: 중간 저장 데이터 서버 작업
        axios.post('/research/create/save', rs)
            .then(function (response) {
                console.log(response);
            })
            .catch(function (error) {
                console.log(error);
            });


        // 확인 메시지 또는 다른 작업을 추가할 수 있습니다.
        alert('중간 저장되었습니다.');
        console.log(rs);
    }

    function addSuriForm(questionNumber) {
        // 새로운 suri 폼을 생성
        const suriForm = document.createElement('div');
        suriForm.classList.add('mb-3');
        suriForm.classList.add('suri-form');
        suriForm.classList.add('border')
        suriForm.classList.add('border-primary')
        suriForm.classList.add('p-5')
        suriForm.id = `suri_no_${questionNumber}`;

        // sur_seq input 생성 및 설정
        const surSeqInput = document.createElement('input');
        surSeqInput.type = 'hidden';
        surSeqInput.name = `suri_seq_${questionNumber}`;
        let suriData = rs.suri.find(suri => suri.suri_no === questionNumber.toString());
        surSeqInput.value = suriData ? suriData.suri_seq : '';
        suriForm.appendChild(surSeqInput);

        // suri_no input 생성 및 설정
        const suriNoInput = document.createElement('input');
        suriNoInput.type = 'hidden';
        suriNoInput.name = `suri_no_${questionNumber}`;
        suriNoInput.value = questionNumber;
        suriForm.appendChild(suriNoInput);


        // 질문 제목 input 생성 및 설정
        const questionTitleLabel = document.createElement('label');
        questionTitleLabel.textContent = `Question ${questionNumber}:`;
        suriForm.appendChild(questionTitleLabel);

        const questionTitleInput = document.createElement('input');
        questionTitleInput.type = 'text';
        questionTitleInput.classList.add('form-control');
        questionTitleInput.name = `suri_title_${questionNumber}`;
        questionTitleInput.value = suriData ? suriData.suri_title : "";
        suriForm.appendChild(questionTitleInput);


        const optionContainer = document.createElement('div');
        // todo: 여기 마진 줘서 앞으로 당기기
        optionContainer.classList.add('ms-5')


        // 질문 보기 (1부터 5까지) input 생성 및 설정
        for (let i = 1; i <= 5; i++) {
            const questionOptionLabel = document.createElement('label');
            questionOptionLabel.textContent = `Option ${i}:`;
            optionContainer.appendChild(questionOptionLabel);

            const questionOptionInput = document.createElement('input');
            questionOptionInput.type = 'text';
            questionOptionInput.classList.add('form-control');
            questionOptionInput.name = `suri_que${i}_${questionNumber}`;
            // suriData가 있을 경우 기존 데이터를 입력
            if (suriData) {
                questionOptionInput.value = suriData[`suri_que${i}`];
            }
            optionContainer.appendChild(questionOptionInput)
        }
        suriForm.appendChild(optionContainer);

        // suri_type 선택 input 생성 및 설정 (체크박스로 변경)
        const suriTypeCheckbox = document.createElement('input');
        suriTypeCheckbox.type = 'checkbox';
        suriTypeCheckbox.classList.add('form-check-input');
        suriTypeCheckbox.name = `suri_type_${questionNumber}`;
        suriTypeCheckbox.value = '3'; // suri_type 3은 주관식
        suriForm.appendChild(suriTypeCheckbox);

        const suriTypeLabel = document.createElement('label');
        suriTypeLabel.classList.add('form-check-label');
        suriTypeLabel.textContent = 'Open Ended (3)';
        suriTypeLabel.htmlFor = `suri_type_${questionNumber}`;
        suriForm.appendChild(suriTypeLabel);

        // 선택 사유 input 생성 및 설정 (체크박스 체크 시 보이도록)
        const suriReasonInput = document.createElement('input');
        suriReasonInput.type = 'text';
        suriReasonInput.classList.add('form-control');
        suriReasonInput.name = `suri_reason_${questionNumber}`;
        suriReasonInput.placeholder = 'Select Reason';
        suriReasonInput.style.display = suriTypeCheckbox.checked ? 'block' : 'none'; // suri_type 체크 시 보이도록
        suriForm.appendChild(suriReasonInput);

        // suri_type 체크박스 이벤트 리스너 추가
        suriTypeCheckbox.addEventListener('change', function () {
            suriReasonInput.style.display = this.checked ? 'block' : 'none';
        });

        // "Delete" 버튼 추가
        // const deleteButton = document.createElement('button');
        // deleteButton.type = 'button';
        // deleteButton.classList.add('btn', 'btn-danger');
        // deleteButton.textContent = 'Delete';
        // deleteButton.addEventListener('click', function () {
        //     // 삭제 버튼 클릭 시 실행할 로직 추가
        //     deleteSuriForm(questionNumber);
        // });
        // suriForm.appendChild(deleteButton);

        // research-query-container에 추가
        const container = document.getElementById('research-query-container');
        container.appendChild(suriForm);
        if(suriForm.querySelector('input[name^="suri_seq_"]')){
            // console.log(suriForm.querySelector('input[name^="suri_seq_"]').value)
            let suri_seq = suriForm.querySelector('input[name^="suri_seq_"]').value
            deletedQueryId=deletedQueryId.filter(_suri_seq=> _suri_seq!==suri_seq)
        }
        // let suriForms = document.querySelector('#research-query-container')
        // if(suriForms.lastChild){
        //     console.log(suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value)
        //     let suri_seq=suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value
        //     deletedQueryId.push(suri_seq)
        //     // suri_que5: form.querySelector(`input[name^="suri_que5_"]`).value,
        //     // deletedQueryId
        // }
    }

    function deleteSuriForm() {
        let suriForms = document.querySelector('#research-query-container')
        if(suriForms.lastChild){
            console.log(suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value)
            let suri_seq=suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value
            deletedQueryId.push(suri_seq)
            // suri_que5: form.querySelector(`input[name^="suri_que5_"]`).value,
            // deletedQueryId
        }
        if (suriForms.lastChild) suriForms.lastChild.remove()

    }


</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>OneDay Research</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.1.3/css/bootstrap.min.css">
</head>
<body>

<div th:insert="~{fragments/navbar :: nav_bar('Create')}"></div>
<div class="container">

    <h3 class="my-4">Create Research</h3>

    <div id="create-form">
        <div class="mb-3">
            <label for="research-title-input" class="form-label">Title</label>
            <input type="text" class="form-control" id="research-title-input" name="title"
                   th:value="${rsDTO.sur_title}"
                   onkeyup="validateInput(this,100)">
            <small id="research-title-input-help" class="form-text text-muted"></small>
        </div>
        <div class="mb-3">
            <label for="research-writer-input" class="form-label">Writer</label>
            <input type="text" class="form-control" id="research-writer-input" name="writer"
                   th:value="${rsDTO.reg_name}" disabled>
        </div>
        <!--        기간 (달력 팝업)-->

        <div class="mb-3 row">
            <label for="research-startdate-input" class="col-2 col-form-label">Start Date</label>
            <div class="col-4">
                <input type="datetime-local" class="form-control" id="research-startdate-input" name="startdate"
                       th:value="${rsDTO.sur_sat_date}"
                       th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd''T''HH:mm')}"
                       oninput="document.querySelector('#research-enddate-input').min = this.value;">
            </div>

            <label for="research-enddate-input" class="col-2 col-form-label">End Date</label>
            <div class="col-4">
                <input type="datetime-local" class="form-control" id="research-enddate-input" name="enddate"
                       th:value="${rsDTO.sur_end_date}"
                       th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd''T''HH:mm')}">
            </div>
        </div>

        <div class="mb-3">
            <label for="research-content-input" class="form-label">Content</label>
            <textarea class="form-control" id="research-content-input" name="content" rows="6"
                      onkeyup="validateInput(this,1000)">[[${rsDTO.sur_desc}]]
            </textarea>
            <small id="research-content-input-help" class="form-text text-muted">0 / 1000 characters</small>
        </div>

        <!--        <div class="mb-3">-->
        <!--            <label for="num-of-questions-input" class="form-label">Number of Questions</label>-->
        <!--            <input type="number" class="form-control" id="num-of-questions-input" name="num_of_questions" min="1"-->
        <!--                   value="1">-->
        <!--        </div>-->
        <div class="mb-3">
            <button type="button" class="btn btn-primary" id="add-question-button"
                    onclick="addSuriForm(document.querySelector('#research-query-container').childElementCount + 1)">
                Plus Query
            </button>
            <button type="button" class="btn btn-primary" id="remove-question-button" onclick="deleteSuriForm()">Minus
                Query
            </button>
            <button type="button" class="btn btn-primary" id="save-button" onclick="updateResearchDTO()">Save Draft
            </button>
            <button type="button" class="btn btn-primary" id="submit-button" onclick="submitResearchDTO()">Submit
            </button>
        </div>
        <div id="research-query-container"></div>


    </div>
</div>
<script>

</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let rsDTO = [[${rsDTO}]];
    // let deletedQueryId=[];
    /*]]>*/

</script>
<script>
    // 페이지 로드 시 초기 데이터를 rsDTO에서 가져와서 suri 폼을 생성합니다.

    window.addEventListener('load', function () {
        // localStorage에 저장된 rsDTO가 있을 경우 가져옵니다.
        if (localStorage.getItem('rsDTO')) {
            rsDTO = JSON.parse(localStorage.getItem('rsDTO'));
        }
        loadRS();
        console.log(rsDTO)
        // research-title-input의 value를 가져옵니다.

    });

    // rsDTO를 이용하여 초기 suri 폼을 생성하는 함수
    function loadRS() {
        let suriList = rsDTO.suri;
        suriList.sort((a, b) => {
            return a.suri_no - b.suri_no;
        })
        let lastSuriNo = suriList[suriList.length - 1]
        if (lastSuriNo) {
            lastSuriNo = lastSuriNo.suri_no
            for (let i = 1; i <= lastSuriNo; i++) {
                addSuriForm(i);
            }
        }
        //     rsDTO의 title content date 값을 이용하여 초기 값 설정
        document.getElementById('research-title-input').value = rsDTO.sur_title;
        document.getElementById('research-content-input').value = rsDTO.sur_desc;
        document.getElementById('research-startdate-input').value = rsDTO.sur_sat_date;
        document.getElementById('research-enddate-input').value = rsDTO.sur_end_date;
        // document.getElementById('num-of-questions-input').value = rsDTO.que_cnt;
        const researchTitleInput = document.getElementById('research-title-input');
        const titleHelp = document.getElementById('research-title-input-help');

        // value의 length를 계산하고 내용을 업데이트합니다.
        const inputLength = researchTitleInput.value.length;
        titleHelp.textContent = `${inputLength} / 100 characters`;

        const researchContentInput = document.getElementById('research-content-input');
        const contentHelp = document.getElementById('research-content-input-help');

        const contentLength = researchContentInput.value.length;
        contentHelp.textContent = `${contentLength} / 1000 characters`;

        // Load the Suri forms
        suriList.sort((a, b) => {
            return a.suri_no - b.suri_no;
        });

        for (let i = 0; i < suriList.length; i++) {
            const suri = suriList[i];
            const questionNumber = suri.suri_no;

            // Add a Suri form
            // addSuriForm(questionNumber);

            // Set the Suri title and options (1 to 5)
            for (let j = 1; j <= 5; j++) {
                 // Use an empty string if the option is not available
                document.querySelector(`input[name^="suri_que${j}_${questionNumber}"]`).value = suri[`suri_que${j}`] || '';
            }

            // Set the Suri multi value
            document.querySelector(`input[name^="suri_multi_${questionNumber}"]`).value = suri.suri_multi;

            // Set the selected Suri etc radio button (Yes or No)
            const selectedEtcValue = suri.suri_etc || 'No'; // Use 'No' as the default if not available
            document.querySelector(`input[name^="suri_etc_${questionNumber}"][value="${selectedEtcValue}"]`).checked = true;

            // Set the Suri title (if available)
             // Use an empty string if the title is not available
            document.querySelector(`input[name^="suri_title_${questionNumber}"]`).value = suri.suri_title || '';
        }

    }

    function updateResearchDTO(flag) {
        const suriForms = document.querySelectorAll('.suri-form');
        const updatedSuriData = [];
        suriForms.forEach((form, index) => {
            const questionNumber = index + 1;
            const suriData = {
                sur_seq: rsDTO.sur_seq,
                suri_seq: form.querySelector(`input[name^="suri_seq_"]`).value,
                suri_no: form.querySelector(`input[name^="suri_no_"]`).value,
                suri_title: form.querySelector(`input[name^="suri_title_"]`).value,
                suri_que1: form.querySelector(`input[name^="suri_que1_"]`).value,
                suri_que2: form.querySelector(`input[name^="suri_que2_"]`).value,
                suri_que3: form.querySelector(`input[name^="suri_que3_"]`).value,
                suri_que4: form.querySelector(`input[name^="suri_que4_"]`).value,
                suri_que5: form.querySelector(`input[name^="suri_que5_"]`).value,
                suri_multi: form.querySelector(`input[name^="suri_multi_${questionNumber}"]`).value,
                suri_etc: form.querySelector(`input[name^="suri_etc_${questionNumber}"]:checked`).value,
            };
            updatedSuriData.push(suriData);
        });

        // rs 업데이트
        rsDTO.suri = updatedSuriData;

        // research-title-input
        rsDTO.sur_title = document.getElementById('research-title-input').value;
        // research-content-input
        rsDTO.sur_desc = document.getElementById('research-content-input').value;
        // research-startdate-input
        rsDTO.sur_sat_date = document.getElementById('research-startdate-input').value;
        // research-enddate-input
        rsDTO.sur_end_date = document.getElementById('research-enddate-input').value;
        // num-of-questions-input
        // rs.que_cnt = document.getElementById('num-of-questions-input').value;
        // deletedQueryId
        // rs.deletedQueryId=deletedQueryId


        // TODO: 중간 저장 데이터 서버 작업
        // axios.post('/research/create/save', rsDTO)
        //     .then(function (response) {
        //         console.log(response);
        //     })
        //     .catch(function (error) {
        //         console.log(error);
        //     });
        // localStorage에 rsDTO 저장
        localStorage.setItem('rsDTO', JSON.stringify(rsDTO));


        // 확인 메시지 또는 다른 작업을 추가할 수 있습니다.
        if (flag === 'submit') {
            // submitResearchDTO()
        } else {
            alert('중간 저장되었습니다.');
        }
        console.log(rsDTO);
    }

    function addSuriForm(questionNumber) {
        // 이미 해당 번호의 Suri 폼이 존재하는지 확인
        // 절대 실행 안되지만 안전장치
        const existingForm = document.getElementById(`suri_no_${questionNumber}`);
        if (existingForm) {
            return; // 이미 존재하면 추가하지 않음
        }
        // div 요소 생성
        const suriForm = document.createElement('div');
        suriForm.classList.add('mb-3');
        suriForm.classList.add('suri-form');
        suriForm.classList.add('border');
        suriForm.classList.add('border-primary');
        suriForm.classList.add('p-5');
        suriForm.id = `suri_no_${questionNumber}`;

        // sur_seq input 생성 및 설정
        const surSeqInput = createHiddenInput(`suri_seq_${questionNumber}`);
        surSeqInput.value = '';
        suriForm.appendChild(surSeqInput);

        // suri_no input 생성 및 설정
        const suriNoInput = createHiddenInput(`suri_no_${questionNumber}`);
        suriNoInput.value = questionNumber;
        suriForm.appendChild(suriNoInput);

        // 질문 제목 input 생성 및 설정
        const questionTitleLabel = createLabel(`Question ${questionNumber}:`);
        suriForm.appendChild(questionTitleLabel);

        const questionTitleInput = createTextInput(`suri_title_${questionNumber}`,questionNumber);
        suriForm.appendChild(questionTitleInput);
        addValidationAndLimit(questionTitleInput, 200);

        const optionContainer = document.createElement('div');
        optionContainer.classList.add('ms-5');

        // 질문 보기 (1부터 5까지) input 생성 및 설정
        for (let i = 1; i <= 5; i++) {
            const questionOptionLabel = createLabel(`Option ${i}:`);
            optionContainer.appendChild(questionOptionLabel);

            const questionOptionInput = createTextInput(`suri_que${i}_${questionNumber}`,questionNumber);
            optionContainer.appendChild(questionOptionInput);
            addValidationAndLimit(questionOptionInput, 100);
            // 유효성 검사와 option을 구분 짓기 위한 비어있는 div 요소 추가
            const optionDiv = document.createElement('div');
            optionDiv.classList.add('mb-3');
            optionContainer.appendChild(optionDiv);

        }

        suriForm.appendChild(optionContainer);

        // 질문 multi input 생성 및 설정
        // 숫자 입력 필드 생성

        const questionMultiInput = createMultiInput(questionNumber);
        // questionMultiInput.value = 1;
        suriForm.appendChild(questionMultiInput);

        // 질문 etc input 생성 및 설정
        const etcLabel = createLabel('Select an option:');
        suriForm.appendChild(etcLabel);

        const etcOptionsContainer = document.createElement('div');
        etcOptionsContainer.classList.add('mb-3');

        // Create radio buttons for "Yes" and "No"
        const optionYes = createRadioOption(questionNumber, 'Yes', false);
        const optionNo = createRadioOption(questionNumber, 'No', true);

        etcOptionsContainer.appendChild(optionYes);
        etcOptionsContainer.appendChild(optionNo);

        suriForm.appendChild(etcOptionsContainer);


        // research-query-container에 추가
        const container = document.getElementById('research-query-container');
        container.appendChild(suriForm);
    }


    function createHiddenInput(name) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        return input;
    }

    function createLabel(text) {
        const label = document.createElement('label');
        label.textContent = text;
        return label;
    }

    function createTextInput(name,questionNumber) {
        const input = document.createElement('input');
        input.type = 'text';
        input.classList.add('form-control');
        input.name = name;
        // try {
        //     if (rsDTO.suri.length > 0) {
        //         const suri = rsDTO.suri[questionNumber - 1];
        //         // suri title 과 suri option 의 초기값 설정
        //         console.log(suri)
        //         if (name === `suri_title_${questionNumber}`) {
        //             input.value = suri.suri_title;
        //         } else {
        //             input.value = suri[`suri_que${name.match(/\d+/)[0]}_`];
        //         }
        //     }
        // } catch (e) {
        //     input.value = '';
        // }


        return input;
    }

    // Function to create a radio button for "Yes" or "No"
    function createRadioOption(questionNumber, label, isSelected) {
        const radioInput = document.createElement('input');
        radioInput.type = 'radio';
        radioInput.id = `suri_etc_${questionNumber}_${label.toLowerCase()}`;
        radioInput.name = `suri_etc_${questionNumber}`;
        radioInput.value = label.toLowerCase();

        // checked 값은 rsDTO에서 가져오고 없다면 No로 설정
            if (isSelected) {
                radioInput.checked = true;
            }
        // try {
        //     if (rsDTO.suri.length > 0) {
        //         const suri = rsDTO.suri[questionNumber - 1];
        //         if (suri.suri_etc === label.toLowerCase()) {
        //             radioInput.checked = true;
        //         }
        //     } else {
        //         if (label === 'No') {
        //             radioInput.checked = true;
        //         }
        //     }
        // } catch (e) {
        //     if (isSelected) {
        //         radioInput.checked = true;
        //     }
        // }


        const radioLabel = document.createElement('label');
        radioLabel.setAttribute('for', `suri_etc_${questionNumber}_${label.toLowerCase()}`);
        radioLabel.textContent = label;

        const radioContainer = document.createElement('div');
        radioContainer.appendChild(radioInput);
        radioContainer.appendChild(radioLabel);

        return radioContainer;
    }

    function createMultiInput(questionNumber) {
        const questionMultiLabel = createLabel('Multi:');
        const questionMultiInput = document.createElement('input');
        questionMultiInput.type = 'number';
        questionMultiInput.classList.add('form-control');
        questionMultiInput.name = `suri_multi_${questionNumber}`;
        questionMultiInput.min = 1;
        questionMultiInput.max = 5;
        questionMultiInput.value = 1;

        // Set the value based on data in rsDTO
        // try {
        //     if (rsDTO.suri.length > 0) {
        //         const suri = rsDTO.suri[questionNumber - 1];
        //         questionMultiInput.value = suri.suri_multi;
        //     } else {
        //         questionMultiInput.value = 1;
        //     }
        // } catch (e) {
        //     questionMultiInput.value = 1;
        // }

        const multiContainer = document.createElement('div');
        multiContainer.appendChild(questionMultiLabel);
        multiContainer.appendChild(questionMultiInput);

        return multiContainer;
    }


    function addValidationAndLimit(input, maxLength) {
        const helpElement = document.createElement('small');
        helpElement.name = input.name + '-help';
        helpElement.classList.add('form-text');
        // helpElement.classList.add('text-muted');
        // input 요소의 초기값을 이용하여 길이를 설정
        const initialLength = input.value.length;
        helpElement.textContent = `${initialLength} / ${maxLength} characters`;

        // 부모 요소가 존재할 때만 appendChild 호출
        if (input.parentNode) {
            input.parentNode.appendChild(helpElement);
        }

        input.addEventListener('input', function () {
            const inputLength = input.value.length;
            helpElement.textContent = `${inputLength} / ${maxLength} characters`;
            if (inputLength > maxLength) {
                helpElement.classList.add('text-danger');
                input.classList.add('is-invalid');
                setTimeout(function () {
                    input.value = input.value.substring(0, maxLength);
                    helpElement.textContent = `${maxLength} / ${maxLength} characters`;
                    helpElement.classList.remove('text-danger');
                    input.classList.remove('is-invalid');
                }, 1000);
            } else {
                helpElement.classList.remove('text-danger');
                input.classList.remove('is-invalid');
            }
        });
    }

    function deleteSuriForm() {
        let suriForms = document.querySelector('#research-query-container')
        // if(suriForms.lastChild){
        //     console.log(suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value)
        //     let suri_seq=suriForms.lastChild.querySelector('input[name^="suri_seq_"]').value
        // }
        if (suriForms.lastChild) suriForms.lastChild.remove()
    }


    function validateInput(input, maxLength) {
        const helpElement = document.getElementById(input.id + '-help');
        const inputLength = input.value.length;
        helpElement.textContent = `${inputLength} / ${maxLength} characters`;
        if (inputLength > maxLength) {
            helpElement.classList.add('text-danger');
            input.classList.add('is-invalid');
            // 1초 뒤에 maxLength 길이로 자르기
            helpElement.textContent = `${inputLength} / ${maxLength} characters` + `  최대 ${maxLength}자까지 입력 가능합니다.`;
            setTimeout(() => {
                input.value = input.value.substring(0, maxLength);
                helpElement.textContent = `${maxLength} / ${maxLength} characters`;
            }, 1000);
        } else {
            helpElement.classList.remove('text-danger');
            input.classList.remove('is-invalid');
        }
    }


    function submitResearchDTO() {
        updateResearchDTO('submit')

        // 유효성 검사 수행

        // 제목과 내용 유효성 검사
        const titleInput = document.getElementById('research-title-input');
        const contentInput = document.getElementById('research-content-input');
        if (!validateTitleAndContent(titleInput, contentInput)) {
            return; // 유효성 검사 실패 시 중단
        }

        // Suri 관련 유효성 검사
        const suriForms = document.querySelectorAll('.suri-form');
        for (let i = 0; i < suriForms.length; i++) {
            const suriForm = suriForms[i];
            const suriTitleInput = suriForm.querySelector(`input[name^="suri_title_"]`);
            const suriOptions = [];
            for (let j = 1; j <= 5; j++) {
                const optionInput = suriForm.querySelector(`input[name^="suri_que${j}_"]`);
                suriOptions.push(optionInput);
            }

            // Suri title이 빈칸이 아닌지 확인
            if (!suriTitleInput.value.trim()) {
                alert('질문 제목은 빈칸이 될 수 없습니다.');
                suriTitleInput.focus();
                window.scrollTo(0, suriTitleInput.offsetTop);
                return; // 유효성 검사 실패 시 중단
            }

            // Suri 옵션 입력 필드가 1번부터 차례대로 값이 들어가고 빈칸이 없는지 확인
            let currentOption = true; // 현재 옵션 입력 필드에 값이 있는지 여부
            let previousOption = true; // 이전 옵션 입력 필드에 값이 있는지 여부
            for (let j = 0; j < suriOptions.length; j++) {
                const optionInput = suriOptions[j];
                const optionNumber = parseInt(optionInput.name.match(/\d+/)[0]); // input의 번호 파싱
                const optionValue = optionInput.value.trim();
                currentOption = optionValue !== '';

                // 첫번째 옵션 입력 필드에 값이 없을 때
                if (optionNumber === 1 && !currentOption) {
                    alert('질문의 선택지 1은 빈칸이 될 수 없습니다.');
                    optionInput.focus();
                    window.scrollTo(0, optionInput.offsetTop);
                    return; // 유효성 검사 실패 시 중단
                }


                // 현재 옵션 입력 필드에 값이 있는데 이전 옵션 입력 필드에 값이 비어있는 경우
                if (currentOption && !previousOption) {
                    alert(`질문의 선택지 ${optionNumber - 1}은(는) 빈칸이 될 수 없습니다.`);
                    suriOptions[j - 1].focus();
                    window.scrollTo(0, suriOptions[j - 1].offsetTop);
                    return; // 유효성 검사 실패 시 중단
                }
                previousOption = currentOption;
            }
        }


        // rsDTO 객체를 JSON 형식으로 변환
        const requestData = JSON.stringify(rsDTO);

        // Axios를 사용하여 POST 요청 전송
        axios.post('/research/create', requestData, {
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(function (response) {
                // 성공적으로 서버에서 응답을 받은 경우
                alert('데이터가 성공적으로 전송되었습니다.');
            })
            .catch(function (error) {
                // 오류 발생 시 처리
                console.error('데이터 전송 중 오류가 발생했습니다.', error);
                alert('데이터 전송 중 오류가 발생했습니다.')
            });
    }

    function validateTitleAndContent(titleInput, contentInput) {
        // 제목 유효성 검사
        if (!titleInput.value.trim()) {
            alert('제목을 입력해주세요.');
            titleInput.focus();
            return false; // 유효성 검사 실패
        }

        // 내용 유효성 검사
        if (!contentInput.value.trim()) {
            alert('내용을 입력해주세요.');
            contentInput.focus();
            return false; // 유효성 검사 실패
        }

        // 다른 필요한 유효성 검사 규칙을 여기에 추가

        return true; // 모든 유효성 검사 통과
    }

</script>
</body>
</html>